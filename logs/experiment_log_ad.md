# 概要
コードの分析結果やメモを記録

# 履歴
# 分析内容 Ver2.0
## 実施内容
- 4つのCSVの統合
- event_typeをワンホットエンコーディング
- 各特徴量の分布を確認

## 今後の予定
- データの前処理（特徴量）
- KMeans法を用いてクラスタリングを実施
- LightGBM、ランダムフォレストなどでClick・Purchseそれぞれの行動予測を実施

クラスタリング、行動予測はユーザー属性を示す特徴量、広告属性を示す特徴量、ユーザー・広告属性を統合した特徴量による3パターンを実施。
また、ユーザーセグメントｘ広告セグメントによる行動予測も実施予定

## 分析結果 Ver2.0
特徴量の分布は下記の通り
- 性別はやや男性寄り
- 年齢は20代がピーク。40代以上は少数
- 曜日による傾向さは見られない
- 国はアメリカ・イギリスが上位
- 広告タイプはストーリーズがやや多めだが、カルーセル・イメージ・動画それぞれ一定数あり
- 広告プラットフォームはFacebookとInstagramの2種類。Facebookが多め

# ユーザー特徴量でのクラスタリングの検証（Ver1.1）
## 🔄 実施内容
- 特徴量に以下を使用
"day_of_week","user_gender","user_age","hour_sin","hour_cos"
"art","fashion","finance","fitness","food","gaming","health","lifestyle","news","photography","sports","technology","travel"
- カテゴリカル変数として"day_of_week","user_gender"をワンホットエンコーディング
- k=5 を仮置きで設定
- 標準化＋PCAで2次元化して分布確認

10/20 追記
- 今回の結果をDBI（デイビス・ボールディン指数）とCH（カリンスキー・ハラバス指数）で評価
    DBI：クラスター間の分離の良さとクラスター内部の密集度のバランスを見る指標
        値が小さいほど良い（基準1.0未満なら許容。0.5未満なら良好）
    CH：クラスター間の分散とクラスター内部の分散の比率を見る指標
        値が大きいほど良い
    シルエットスコアも出したかったが、計算が重いため、今回は割愛
    
- 各クラスターの特徴量を可視化

## ⚙️ 使用データ
- users.csv
- events.csv

## 📊 現状の結果
- PCAのX軸は年齢の影響を強く受けている印象。（X軸のみでクラスタが決定されている状況）
- Y軸はカテゴリカル変数が多すぎて分散している。

10/20 追記
- 評価指標 
    DBI：2.618 のため、評価❌
    CH：26696.857のため、評価🟢
        ⇒クラスタ間の距離も内部の距離も大きいため、上手く分けられていない可能性が高い

- 各クラスタの特徴比較
    標準化したままで出力したため、年齢や時間の影響は読み取りにくいが、以下のことが分かった
    クラスタ0のみ年齢の値が大きい
    クラスタ毎に時刻（hour_sin,cos）の値の差が大きい
    各interestカテゴリの差はあまり見られない
    曜日の差もあまり見られない
    クラスタ0~2は性別差はあまり見られない（大体男性 55%前後、女性 35%前後、その他11%）が、クラスタ3では女性比率が81%、クラスタ4では男性比率が100%となっており、性別による傾向差が見られた
        ⇒年齢、時刻、性別がクラスタ分けに影響している

## 🚧 今後の課題
- カテゴリカル変数のエンコーディング方法を見直して再検証
day_of_week：周期エンコーディング など

- 各クラスタの特徴量確認時に年齢や時刻を標準化前の状態に戻して確認する
- 各クラスタのCTR、CVRも確認する

- 年齢の分布の偏りが大きいので、DBSCANによるクラスタリングも検証

# ユーザー特徴量でのクラスタリングの検証（Ver1.2）
## 🔄 実施内容（Ver1.1からの変更点）
- "day_of_week" をワンホットエンコーディング⇒周期エンコーディングに変更して検証
- 後処理として、年齢、時間、曜日を元に戻して各クラスタの特徴を確認

## 📊 現状の結果
- DBI：2.662、CH：26674.206 となり、曜日をワンホットエンコーディングでやったときよりも分離がなくなりわずかにスコアは悪化した。
- 各クラスタの特徴は下記の通り
    年齢ではクラスタ0~3は平均 24歳、4のみ41歳
    時間帯の平均値は全て11.5となり傾向差がみられない（平均だけで判断出来ないため、追って指標を追加）
    性別も全クラス 女性34~35%、男性55~56%、その他10%となり差分がなくなった。
    曜日については、クラスタ0が土日のみ、クラスタ1・3が水~金、クラスタ2が月～火、クラスタ4は前曜日均等という分かれ方になった。
    今回、指標は悪化したが、クラスタの分かれ方としては、年齢、及び曜日が影響している結果となった。

## 🚧 今後の課題
### 処理内容
- カテゴリカル変数のエンコーディング方法を見直して再検証
    興味関心のエンコーディングを変更
        ⇒まずは興味関心を外してみて影響があるか確認
- 年齢の分布の偏りが大きいので、DBSCANによるクラスタリングも検証

### 確認指標
- 各クラスタのCTR、CVRも確認する
- 時間帯について分布の確認も追加 

# ユーザー特徴量でのクラスタリングの検証（Ver1.3）
## 🔄 実施内容（Ver1.3からの変更点）
- 特徴量から興味関心カテゴリを外して検証

## 📊 現状の結果
- DBI：2.662 ⇒ 1.979、CH：26674.206 ⇒ 46550.501 に改善
- 2次元散布図での変化は見られず
- 各クラスタの特徴には変化なし（曜日や年齢による傾向が強い）

⇒興味関心がノイズになっていたと判断し、このまま外して検証を進める。

## 🚧 今後の課題
### 処理内容
- まず、k数の検証を実施
- 年齢の分布の偏りが大きいので、DBSCANによるクラスタリングも検証

### 確認指標
- 各クラスタのCTR、CVRも確認する
- 時間帯について分布の確認も追加 

# ユーザー特徴量でのクラスタリングの検証（Ver1.4）
## 🔄 実施内容（Ver1.3からの変更点）
- kを2~10の範囲で検証。DBI、CHの値で評価。

## 📊 現状の結果
- 結果は下記の通り
DBI最小はk=8
CH最大はk=2

k	DBI	CH
2	2.052676111	70638.56782
3	2.139396153	58059.83921
4	1.926125073	51925.8586
5	1.979236184	46550.50054
6	1.761140292	42648.06163
7	1.848851154	39727.23589
8	1.722359442	37885.87613
9	1.778697961	36006.16227
10	1.74626611	34484.86069


## 🚧 今後の課題
### 処理内容
- DBI,CHのバランスからk=4,6,8それぞれの分布図の可視化を作成し検証

# ユーザー特徴量でのクラスタリングの検証 (v1.5)
## 🔄 実施内容（Ver1.4からの変更点）
- k=4,6,8 でそれぞれのクラスタリングを2次元散布図で可視化

## 📊 現状の結果
- 散布図での分離はk=6が一番良さそう

## 🚧 今後の課題
### 処理内容
- k=6 にして、各クラスタの特徴量や平均CTR・CVRを算出

# ユーザー特徴量でのクラスタリングの検証 (v1.6)
## 🔄 実施内容（Ver1.5からの変更点）
- k=6 にして、各クラスタの特徴量や平均CTR・CVRを算出

## 📊 現状の結果
- 各クラスタでのCTR差は見られず。CVRはクラスタ1・4・5がやや高い結果に。
- 各クラスタの特徴（想定ペルソナ）は以下の通り
    0：週前半の出勤時間帯での閲覧ユーザー。他クラスタに比べ、ややCTRが低い。CVRもクラスタ2に次いで低い。
    1：平均年齢42歳のユーザー（これ以外の平均年齢はいずれも25歳）、閲覧時間は午前中。CVR良好。
    2：日・月の夕方閲覧ユーザー。CVRは低い。
    3：週後半のお昼時に閲覧しているユーザー
    4：週末の午前中に閲覧しているユーザー。CVR良好。
    5：週中のお昼時に閲覧しているユーザー。CVR良好。

⇒総評：CTRに大きな差はないが、週前半の通勤時間帯はCTRが下がるため出稿を抑えたい。
その代わり、
・週末の午前や週後半のお昼時
・40代以上の高めの年齢層
などでの広告出稿を強めることで全体のCVR向上が期待できる。

## 🚧 今後の課題
### 処理内容
- 広告に基づく特徴量、ユーザー・広告特徴量をマージしたもの それぞれでクラスタリングを実施

# 広告特徴量でのクラスタリングの検証 (v1.0)

## 🧭 目的
広告特徴量でのクラスタリングを実施。

## 🔄 実施内容
- 特徴量に以下を使用
カテゴリカル変数（ワンホットエンコーディング）："ad_platform","ad_type","target_gender","target_age_group","target_interests"
標準化："duration_days","total_budget"
- DBI、CHを評価指標として使用
- k=6 で各クラスタの特徴量の傾向と、平均CTR・CVR・CTVRを算出

## 📊 現状の結果
- DBI：2.581、CH：32467.875 でクラスタの分離がうまく出来ていない
- クラスタごとのCTR差は見られず、CVR差もわずか
- 特徴量として、"ad_platform"は明確にクラスタが分かれている。
- "ad_type"でカルーセルの比率が大きいクラスタはCVRが低めの傾向
- その他、傾向差の無い特徴量はなかった。（ユーザー特徴量ではインタレストが傾向差がなかったが、広告側では傾向差があり影響はありそう。）

## 🚧 今後の課題
### 処理内容
- ワンホットエンコーディングでのカテゴリが多いため、まずは"target_interests"を頻度エンコーディングに変えて様子見
- 特徴量が固まったらkの値を2~10の範囲で検証

# 広告特徴量でのクラスタリングの検証 (v1.1)
## 🔄 実施内容(Ver1.0からの変更点)
- カテゴリ数の多い"target_interests"を2次元でPCAを行ってからクラスタリングを実施

## 📊 現状の結果
- DBI：2.581 ⇒ 2.248、CH：32467.875 ⇒ 42861.458 でVe1.0よりもスコアは改善。ただし、散布図での分離感は変わらず。
- 各クラスタの特徴もVer1.0と大きな差は見られない。（以下の通り）
- クラスタごとのCTR差は見られず、CVR差もわずか
- 特徴量として、"ad_platform"は明確にクラスタが分かれている。
- "ad_type"でカルーセルの比率が大きいクラスタはCVRが低めの傾向
- その他、傾向差の無い特徴量はなかった。（ユーザー特徴量ではインタレストが傾向差がなかったが、広告側では傾向差があり影響はありそう。）

## 🚧 今後の課題
### 処理内容
- CTR/CVRを特徴量に組み込み、クラスタリング力の向上を図る
- それでも足りなければワンホットカテゴリの見直し（特徴量の掛け合わせｘPCAで次元圧縮）を検討
- 特徴量が固まったらkの値を2~10の範囲で検証

# 広告特徴量でのクラスタリングの検証 (v1.2)
## 🔄 実施内容(Ver1.1からの変更点)
- ad_id毎の平均CTR、CVRを特徴量として追加

## 📊 現状の結果
- DBI：2.248 ⇒ 2.107、CH：42861.458 ⇒ 34300.271 でVe1.1よりもDBIは改善。
- 散布図でのまとまりはまだ見られない。
- 各クラスタの特徴は以下の通り
- クラスタごとのCTR、CVR差はみられるようになった。
- CTRへの影響：
    広告タイプとしてStories比重が大きいとCTRが低い
    男性向け比率が低いとCTRが低い（逆にCTRが高いクラスタは男性比率が高い）
    興味関心としてはgaming比重が高いとCTR低い、逆にfitness、sportsはCTRが高い
- CVRへの影響：
    Facebook比重が高い方がCVRは高い、また広告タイプはStoriesが多い方がCVRは高め、image比重が大きいとCVR低め
    18-24歳向けが大きい方がCVRは高め。
    興味関心はばらつきがあるが明確な傾向は見えない。


## 🚧 今後の課題
### 処理内容
- まとまりは不十分だが、クラスタごとの傾向は見えてきたのでkの値を2~10の範囲で検証

# 広告特徴量でのクラスタリングの検証 (v1.3)
## 🔄 実施内容(Ver1.2からの変更点)
- k=2~10 で各クラスタの特徴量のDBI,CHを可視化

## 📊 現状の結果
- kの増加に伴い、DBI,CHともに低下
- 詳細スコアは以下の通り
k	DBI	CH
2	2.250127113	54350.69798
3	2.286327369	46642.80551
4	2.170420295	40597.2696
5	2.128078179	36976.22651
6	2.106792925	34300.27087
7	2.007489019	31549.62431
8	2.008813751	28838.17313
9	2.049310463	28457.14578
10	2.028875267	26840.84368

DBI最小はk=7
CH最大はk=2

## 🚧 今後の課題
### 処理内容
- k=2,4,6,7 でそれぞれクラスタリングした散布図と特徴量の可視化を確認し、最適なクラスタ数を判断

# 広告特徴量でのクラスタリングの検証 (v1.4)
## 🔄 実施内容(Ver1.3からの変更点)
- k=2,4,6,7 それぞれの特徴量、散布図を可視化し最適なクラスタ数を判断

## 📊 現状の結果
- kの増加に伴い、DBI,CHともに低下
- 詳細スコアは以下の通り
k	DBI	CH
2	2.250127113	54350.69798
4	2.170420295	40597.2696
6	2.106792925	34300.27087
7	2.007489019	31549.62431

- 散布図の結果からはk=6 が一番良さそう

## 🚧 今後の課題
### 処理内容
- k=5，6 でそれぞれクラスタリングした散布図と特徴量の可視化を確認し、最適なクラスタ数を最終判断